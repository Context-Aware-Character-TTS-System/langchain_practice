<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RAGâ†’TTS Prompt Demo</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 24px; background:#0b1020; color:#e8ecff; }
    h1 { margin-top:0; font-size: 22px; }
    .card { background:#111737; border:1px solid #2a3160; border-radius:16px; padding:16px; margin-bottom:16px; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1 1 260px; }
    input[type="file"], input[type="text"], select, button, textarea, input[type="number"] { width:100%; padding:10px; border-radius:10px; border:1px solid #2a3160; background:#0f1430; color:#dbe0ff; }
    button { cursor:pointer; border:1px solid #3f6df1; background:#2a46c0; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .log { white-space: pre-wrap; background:#0f1430; border-radius:10px; padding:10px; border:1px dashed #2a3160; max-height: 260px; overflow:auto; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#16204a; border:1px solid #2a3160; margin-right:6px; font-size:12px; }
    .hint { color:#9ab0ff; font-size: 13px; }
    .ok { color:#6be29c }
    .err { color:#ff8c8c }
    label { display:block; margin-bottom:8px; }
  </style>
</head>
<body>
  <h1>ğŸ“š RAG â†’ ğŸ”Š TTS Prompt Demo</h1>

  <div class="card">
    <div class="pill">Step 1</div> <b>ì°¸ê³  ìë£Œ ì—…ë¡œë“œ (ì¸ë±ì‹±)</b>
    <p class="hint">ìµœì†Œ <b>ì†Œì„¤ TXT</b>ë§Œ ì—…ë¡œë“œí•˜ë©´ ë©ë‹ˆë‹¤. ìºë¦­í„° ì¹´ë“œ/ìŠ¤íƒ€ì¼ ê°€ì´ë“œ/ë°œìŒ ì‚¬ì „ì€ ì„ íƒ.</p>
    <div class="row">
      <div class="col">
        <label>ì†Œì„¤ í…ìŠ¤íŠ¸ (.txt)
          <input id="f-novel" type="file" accept=".txt,.md,.markdown,.text" />
        </label>
      </div>
      <div class="col">
        <label>ìºë¦­í„° ì¹´ë“œ (.txt / .md)
          <input id="f-cc" type="file" accept=".txt,.md,.markdown" />
        </label>
      </div>
      <div class="col">
        <label>ìŠ¤íƒ€ì¼ ê°€ì´ë“œ (.txt / .md)
          <input id="f-style" type="file" accept=".txt,.md,.markdown" />
        </label>
      </div>
      <div class="col">
        <label>ë°œìŒ ì‚¬ì „ (.json)
          <input id="f-lex" type="file" accept="application/json,.json" />
        </label>
      </div>
    </div>
    <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
      <button id="btn-ingest">ì¸ë±ì‹± ì‹¤í–‰</button>
      <span id="ingest-status" class="hint"></span>
    </div>
    <div id="ingest-log" class="log" style="margin-top:12px;"></div>
  </div>

  <div class="card">
    <div class="pill">Step 2 (ë‹¨ì¼ ëŒ€ì‚¬)</div> <b>TTS í”„ë¡¬í”„íŠ¸ ìƒì„±</b>
    <div class="row">
      <div class="col">
        <label>Speaker ID
          <input id="speaker" type="text" value="S1" />
        </label>
      </div>
      <div class="col">
        <label>Scene Tag
          <input id="scene" type="text" value="default" />
        </label>
      </div>
    </div>
    <div style="margin-top:8px">
      <label>Utterance
        <textarea id="utterance" rows="3" placeholder="ì—¬ê¸°ì— ëŒ€ì‚¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      </label>
    </div>
    <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
      <button id="btn-tts">TTS JSON ìƒì„±</button>
      <span id="tts-status" class="hint"></span>
    </div>
    <div id="tts-out" class="log" style="margin-top:12px;"></div>
  </div>

  <div class="card">
    <div class="pill">Step 3 (ë°°ì¹˜)</div> <b>ì›ë¬¸ TXT ì „ì²´ â†’ TTS JSON ë¬¶ìŒ</b>
    <p class="hint">ì›ë¬¸ TXTë¥¼ ê·¸ëŒ€ë¡œ ì˜¬ë¦¬ë©´, ìë™ìœ¼ë¡œ <b>í† í° ì œí•œì„ ë„˜ì§€ ì•Šë„ë¡ ë¶„í• </b>í•˜ì—¬ ê° ë°œí™”ë³„ TTS í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ê³ , í•˜ë‚˜ì˜ JSONìœ¼ë¡œ í•©ì³ì„œ ëŒë ¤ì¤ë‹ˆë‹¤.</p>
    <div class="row">
      <div class="col">
        <label>ì›ë¬¸ TXT ì—…ë¡œë“œ
          <input id="f-tts-full" type="file" accept=".txt,.md,.markdown,.text" />
        </label>
      </div>
      <div class="col">
        <label>ì¸ë±ì‹±ë„ í•¨ê»˜ ìˆ˜í–‰ (ê¶Œì¥)
          <select id="also-ingest">
            <option value="true" selected>true</option>
            <option value="false">false</option>
          </select>
        </label>
      </div>
      <div class="col">
        <label>ìµœëŒ€ ì²˜ë¦¬ ë°œí™” ìˆ˜ (í…ŒìŠ¤íŠ¸ìš©)
          <input id="max-items" type="number" placeholder="ì˜ˆ: 50 (ë¹„ìš°ë©´ ì „ì²´)" />
        </label>
      </div>
    </div>
    <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
      <button id="btn-tts-batch">ì „ì²´ TTS JSON ìƒì„±</button>
      <button id="btn-download" disabled>JSON ë‹¤ìš´ë¡œë“œ</button>
      <span id="tts-batch-status" class="hint"></span>
    </div>
    <div id="tts-batch-out" class="log" style="margin-top:12px;"></div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const log = (el, msg, cls="") => {
      el.textContent = msg;
      if (cls) el.className = "log " + cls; else el.className = "log";
    };

    async function ingest() {
      const novel = $('#f-novel').files[0];
      if (!novel) { alert('ì†Œì„¤ í…ìŠ¤íŠ¸ íŒŒì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
      const fd = new FormData();
      fd.append('novel', novel);
      if ($('#f-cc').files[0]) fd.append('character_cards', $('#f-cc').files[0]);
      if ($('#f-style').files[0]) fd.append('style_guide', $('#f-style').files[0]);
      if ($('#f-lex').files[0]) fd.append('lexicon', $('#f-lex').files[0]);

      $('#btn-ingest').disabled = true; $('#ingest-status').textContent = 'ì—…ë¡œë“œ/ì¸ë±ì‹± ì¤‘â€¦';
      log($('#ingest-log'), '');
      try {
        const res = await fetch('/ingest_upload', { method: 'POST', body: fd });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'ingest ì‹¤íŒ¨');
        $('#ingest-status').textContent = 'ì™„ë£Œ âœ…';
        log($('#ingest-log'), JSON.stringify(data, null, 2), 'ok');
      } catch (e) {
        $('#ingest-status').textContent = 'ì‹¤íŒ¨ âŒ';
        log($('#ingest-log'), String(e), 'err');
      } finally {
        $('#btn-ingest').disabled = false;
      }
    }

    async function genTTS() {
      const utterance = $('#utterance').value.trim();
      if (!utterance) { alert('Utteranceë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
      const payload = {
        utterance,
        speaker_id: $('#speaker').value.trim() || 'S1',
        scene: $('#scene').value.trim() || 'default',
      };
      $('#btn-tts').disabled = true; $('#tts-status').textContent = 'ìƒì„± ì¤‘â€¦';
      log($('#tts-out'), '');
      try {
        const res = await fetch('/tts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'ìƒì„± ì‹¤íŒ¨');
        $('#tts-status').textContent = 'ì™„ë£Œ âœ…';
        log($('#tts-out'), JSON.stringify(data, null, 2), 'ok');
      } catch (e) {
        $('#tts-status').textContent = 'ì‹¤íŒ¨ âŒ';
        log($('#tts-out'), String(e), 'err');
      } finally {
        $('#btn-tts').disabled = false;
      }
    }

    async function genBatchTTS() {
      const novel = $('#f-tts-full').files[0];
      if (!novel) { alert('ì›ë¬¸ TXTë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
      const fd = new FormData();
      fd.append('novel', novel);
      const also = $('#also-ingest').value === 'true';
      fd.append('also_ingest', also ? 'true' : 'false');
      const maxItemsVal = $('#max-items').value.trim();
      if (maxItemsVal) fd.append('max_items', maxItemsVal);

      $('#btn-tts-batch').disabled = true; $('#tts-batch-status').textContent = 'ìƒì„± ì¤‘â€¦';
      $('#btn-download').disabled = true;
      log($('#tts-batch-out'), '');
      try {
        const res = await fetch('/tts_from_txt_upload', { method: 'POST', body: fd });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'ë°°ì¹˜ ìƒì„± ì‹¤íŒ¨');
        $('#tts-batch-status').textContent = `ì™„ë£Œ âœ… ì´ ${data.count} í•­ëª©`;
        log($('#tts-batch-out'), JSON.stringify(data, null, 2), 'ok');

        if (data.download_url) {
          const btn = $('#btn-download');
          btn.disabled = false;
          btn.onclick = async () => {
            const r = await fetch(data.download_url);
            const blob = await r.blob();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'tts_prompts.json';
            a.click();
            URL.revokeObjectURL(a.href);
          };
        }
      } catch (e) {
        $('#tts-batch-status').textContent = 'ì‹¤íŒ¨ âŒ';
        log($('#tts-batch-out'), String(e), 'err');
      } finally {
        $('#btn-tts-batch').disabled = false;
      }
    }

    $('#btn-ingest').addEventListener('click', ingest);
    $('#btn-tts').addEventListener('click', genTTS);
    $('#btn-tts-batch').addEventListener('click', genBatchTTS);
  </script>
</body>
</html>
