<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RAG→TTS Prompt Demo</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 24px; background:#0b1020; color:#e8ecff; }
    h1 { margin-top:0; font-size: 22px; }
    .card { background:#111737; border:1px solid #2a3160; border-radius:16px; padding:16px; margin-bottom:16px; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1 1 260px; }
    input[type="file"], input[type="text"], select, button, textarea, input[type="number"] { width:100%; padding:10px; border-radius:10px; border:1px solid #2a3160; background:#0f1430; color:#dbe0ff; }
    button { cursor:pointer; border:1px solid #3f6df1; background:#2a46c0; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .log { white-space: pre-wrap; background:#0f1430; border-radius:10px; padding:10px; border:1px dashed #2a3160; max-height: 260px; overflow:auto; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#16204a; border:1px solid #2a3160; margin-right:6px; font-size:12px; }
    .hint { color:#9ab0ff; font-size: 13px; }
    .ok { color:#6be29c }
    .err { color:#ff8c8c }
    label { display:block; margin-bottom:8px; }
  </style>
</head>
<body>
  <h1>📚 RAG → 🔊 TTS Prompt Demo</h1>

  <div class="card">
    <div class="pill">공통</div> <b>작품 ID 설정</b>
    <p class="hint">작품별로 ID를 지정하면, 같은 DB에서도 검색이 섞이지 않습니다. 비워두면 파일명 기반으로 자동 지정됩니다.</p>
    <div class="row">
      <div class="col">
        <label>작품 ID (corpus_id)
          <input id="corpus-id" type="text" placeholder="예: novel_alpha" />
        </label>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="pill">Step 1</div> <b>참고 자료 업로드 (인덱싱)</b>
    <p class="hint">최소 <b>소설 TXT</b>만 업로드하면 됩니다. 캐릭터 카드/스타일 가이드/발음 사전은 선택.</p>
    <div class="row">
      <div class="col">
        <label>소설 텍스트 (.txt)
          <input id="f-novel" type="file" accept=".txt,.md,.markdown,.text" />
        </label>
      </div>
      <div class="col">
        <label>캐릭터 카드 (.txt / .md)
          <input id="f-cc" type="file" accept=".txt,.md,.markdown" />
        </label>
      </div>
      <div class="col">
        <label>스타일 가이드 (.txt / .md)
          <input id="f-style" type="file" accept=".txt,.md,.markdown" />
        </label>
      </div>
      <div class="col">
        <label>발음 사전 (.json)
          <input id="f-lex" type="file" accept="application/json,.json" />
        </label>
      </div>
    </div>
    <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
      <button id="btn-ingest">인덱싱 실행</button>
      <span id="ingest-status" class="hint"></span>
    </div>
    <div id="ingest-log" class="log" style="margin-top:12px;"></div>
  </div>

  <div class="card">
    <div class="pill">Step 1½</div> <b>TXT만으로 카드/가이드/발음 사전 자동 생성 (A)</b>
    <p class="hint">소설 TXT만 올려도 캐릭터 카드/스타일 가이드/발음 사전을 LLM으로 자동 생성합니다. 필요 시 즉시 인덱싱까지.</p>
    <div class="row">
      <div class="col">
        <label>원문 TXT 업로드
          <input id="f-bootstrap" type="file" accept=".txt,.md,.markdown,.text" />
        </label>
      </div>
      <div class="col">
        <label>인덱싱도 함께 수행
          <select id="bs-ingest">
            <option value="true" selected>true</option>
            <option value="false">false</option>
          </select>
        </label>
      </div>
      <div class="col">
        <label>상위 화자 수
          <input id="bs-top" type="number" value="8" />
        </label>
      </div>
      <div class="col">
        <label>화자당 샘플 줄수
          <input id="bs-lines" type="number" value="40" />
        </label>
      </div>
    </div>
    <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
      <button id="btn-bootstrap">자동 생성</button>
      <button id="btn-bs-ingest-now" disabled>지금 인덱싱</button>
      <a id="dl-cc" class="pill" href="#" style="display:none" download="character_cards.txt">카드 다운로드</a>
      <a id="dl-sg" class="pill" href="#" style="display:none" download="style_guide.md">가이드 다운로드</a>
      <a id="dl-lx" class="pill" href="#" style="display:none" download="lexicon.json">사전 다운로드</a>
      <span id="bs-status" class="hint"></span>
    </div>
    <div id="bs-log" class="log" style="margin-top:12px;"></div>
  </div>

  <div class="card">
    <div class="pill">Step 2 (단일 대사)</div> <b>TTS 프롬프트 생성</b>
    <div class="row">
      <div class="col">
        <label>Speaker ID
          <input id="speaker" type="text" value="S1" />
        </label>
      </div>
      <div class="col">
        <label>Scene Tag
          <input id="scene" type="text" value="default" />
        </label>
      </div>
    </div>
    <div style="margin-top:8px">
      <label>Utterance
        <textarea id="utterance" rows="3" placeholder="여기에 대사를 입력하세요"></textarea>
      </label>
    </div>
    <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
      <button id="btn-tts">TTS JSON 생성</button>
      <span id="tts-status" class="hint"></span>
    </div>
    <div id="tts-out" class="log" style="margin-top:12px;"></div>
  </div>

  <div class="card">
    <div class="pill">Step 3 (배치)</div> <b>원문 TXT 전체 → TTS JSON 묶음</b>
    <p class="hint">원문 TXT를 그대로 올리면, 자동으로 <b>토큰 제한을 넘지 않도록 분할</b>하여 각 발화별 TTS 프롬프트를 생성하고, 하나의 JSON으로 합쳐서 돌려줍니다.</p>
    <div class="row">
      <div class="col">
        <label>원문 TXT 업로드
          <input id="f-tts-full" type="file" accept=".txt,.md,.markdown,.text" />
        </label>
      </div>
      <div class="col">
        <label>인덱싱도 함께 수행 (권장)
          <select id="also-ingest">
            <option value="true" selected>true</option>
            <option value="false">false</option>
          </select>
        </label>
      </div>
      <div class="col">
        <label>최대 처리 발화 수 (테스트용)
          <input id="max-items" type="number" placeholder="예: 50 (비우면 전체)" />
        </label>
      </div>
    </div>
    <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
      <button id="btn-tts-batch">전체 TTS JSON 생성</button>
      <button id="btn-download" disabled>JSON 다운로드</button>
      <span id="tts-batch-status" class="hint"></span>
    </div>
    <div id="tts-batch-out" class="log" style="margin-top:12px;"></div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const log = (el, msg, cls="") => { el.textContent = msg; el.className = cls? "log "+cls : "log"; };
    const getCorpus = () => ($('#corpus-id').value || '').trim();

    async function ingest() {
      const novel = $('#f-novel').files[0];
      if (!novel) { alert('소설 텍스트 파일은 필수입니다.'); return; }
      const fd = new FormData();
      fd.append('novel', novel);
      if ($('#f-cc').files[0]) fd.append('character_cards', $('#f-cc').files[0]);
      if ($('#f-style').files[0]) fd.append('style_guide', $('#f-style').files[0]);
      if ($('#f-lex').files[0]) fd.append('lexicon', $('#f-lex').files[0]);
      const corpus = getCorpus();
      if (corpus) fd.append('corpus_id', corpus);

      $('#btn-ingest').disabled = true; $('#ingest-status').textContent = '업로드/인덱싱 중…';
      log($('#ingest-log'), '');
      try {
        const res = await fetch('/ingest_upload', { method: 'POST', body: fd });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'ingest 실패');
        $('#ingest-status').textContent = `완료 ✅ (corpus=${data.corpus_id || corpus || 'auto'})`;
        log($('#ingest-log'), JSON.stringify(data, null, 2), 'ok');
      } catch (e) {
        $('#ingest-status').textContent = '실패 ❌';
        log($('#ingest-log'), String(e), 'err');
      } finally {
        $('#btn-ingest').disabled = false;
      }
    }

    async function bootstrapA() {
      const novel = $('#f-bootstrap').files[0];
      if (!novel) { alert('원문 TXT를 선택하세요'); return; }
      const fd = new FormData();
      fd.append('novel', novel);
      fd.append('also_ingest', $('#bs-ingest').value === 'true' ? 'true' : 'false');
      const top = ($('#bs-top').value || '8');
      const lines = ($('#bs-lines').value || '40');
      fd.append('top_speakers', top);
      fd.append('max_lines_per_speaker', lines);
      const corpus = getCorpus();
      if (corpus) fd.append('corpus_id', corpus);

      $('#btn-bootstrap').disabled = true; $('#bs-status').textContent = '생성 중… (LLM 호출)';
      log($('#bs-log'), '');
      try {
        const res = await fetch('/bootstrap_from_txt_upload', { method: 'POST', body: fd });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || '자동 생성 실패');
        $('#bs-status').textContent = '완료 ✅';
        log($('#bs-log'), JSON.stringify(data, null, 2), 'ok');

        if (data.session) {
          const btnNow = $('#btn-bs-ingest-now');
          btnNow.dataset.session = data.session;
          btnNow.dataset.corpusId = data.corpus_id || corpus || '';
          if ($('#bs-ingest').value === 'true' && data.added) {
            $('#ingest-status').textContent = `완료 ✅ (부트스트랩 자동 인덱싱, corpus=${data.corpus_id})`;
            log($('#ingest-log'), JSON.stringify({status:'ok', added: data.added, corpus_id: data.corpus_id}, null, 2), 'ok');
          } else {
            btnNow.disabled = false;
          }
        }

        if (data.downloads) {
          const cc = $('#dl-cc'); const sg = $('#dl-sg'); const lx = $('#dl-lx');
          cc.href = data.downloads.character_cards; cc.style.display = 'inline-block';
          sg.href = data.downloads.style_guide;     sg.style.display = 'inline-block';
          lx.href = data.downloads.lexicon;        lx.style.display = 'inline-block';
        }
      } catch (e) {
        $('#bs-status').textContent = '실패 ❌';
        log($('#bs-log'), String(e), 'err');
      } finally {
        $('#btn-bootstrap').disabled = false;
      }
    }

    async function ingestBootstrapSession() {
      const sess = $('#btn-bs-ingest-now').dataset.session;
      const corpusId = $('#btn-bs-ingest-now').dataset.corpusId || getCorpus();
      if (!sess) { alert('세션 정보가 없습니다. 먼저 자동 생성(A)을 실행하세요.'); return; }
      const payload = corpusId ? { session: sess, corpus_id: corpusId } : { session: sess };
      $('#btn-bs-ingest-now').disabled = true; $('#bs-status').textContent = '인덱싱 중…';
      try {
        const res = await fetch('/ingest_session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || '인덱싱 실패');
        $('#bs-status').textContent = `인덱싱 완료 ✅ (corpus=${data.corpus_id || corpusId || 'auto'})`;
        $('#ingest-status').textContent = '완료 ✅ (부트스트랩 경유)';
        log($('#ingest-log'), JSON.stringify(data, null, 2), 'ok');
      } catch (e) {
        $('#bs-status').textContent = '실패 ❌';
        log($('#bs-log'), String(e), 'err');
      } finally {
        $('#btn-bs-ingest-now').disabled = false;
      }
    }

    async function genTTS() {
      const utterance = $('#utterance').value.trim();
      if (!utterance) { alert('Utterance를 입력하세요'); return; }
      const payload = {
        utterance,
        speaker_id: $('#speaker').value.trim() || 'S1',
        scene: $('#scene').value.trim() || 'default',
      };
      const corpus = getCorpus();
      if (corpus) payload.corpus_id = corpus;

      $('#btn-tts').disabled = true; $('#tts-status').textContent = '생성 중…';
      log($('#tts-out'), '');
      try {
        const res = await fetch('/tts', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || '생성 실패');
        $('#tts-status').textContent = '완료 ✅';
        log($('#tts-out'), JSON.stringify(data, null, 2), 'ok');
      } catch (e) {
        $('#tts-status').textContent = '실패 ❌';
        log($('#tts-out'), String(e), 'err');
      } finally {
        $('#btn-tts').disabled = false;
      }
    }

    async function genBatchTTS() {
      const novel = $('#f-tts-full').files[0];
      if (!novel) { alert('원문 TXT를 선택하세요'); return; }
      const fd = new FormData();
      fd.append('novel', novel);
      const also = $('#also-ingest').value === 'true';
      fd.append('also_ingest', also ? 'true' : 'false');
      const maxItemsVal = $('#max-items').value.trim();
      if (maxItemsVal) fd.append('max_items', maxItemsVal);
      const corpus = getCorpus();
      if (corpus) fd.append('corpus_id', corpus);

      $('#btn-tts-batch').disabled = true; $('#tts-batch-status').textContent = '생성 중…';
      $('#btn-download').disabled = true;
      log($('#tts-batch-out'), '');
      try {
        const res = await fetch('/tts_from_txt_upload', { method: 'POST', body: fd });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || '배치 생성 실패');
        $('#tts-batch-status').textContent = `완료 ✅ 총 ${data.count} 항목 (corpus=${data.corpus_id})`;
        log($('#tts-batch-out'), JSON.stringify(data, null, 2), 'ok');

        if (data.download_url) {
          const btn = $('#btn-download');
          btn.disabled = false;
          btn.onclick = async () => {
            const r = await fetch(data.download_url);
            const blob = await r.blob();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'tts_prompts.json';
            a.click();
            URL.revokeObjectURL(a.href);
          };
        }
      } catch (e) {
        $('#tts-batch-status').textContent = '실패 ❌';
        log($('#tts-batch-out'), String(e), 'err');
      } finally {
        $('#btn-tts-batch').disabled = false;
      }
    }

    $('#btn-ingest').addEventListener('click', ingest);
    $('#btn-bootstrap').addEventListener('click', bootstrapA);
    $('#btn-bs-ingest-now').addEventListener('click', ingestBootstrapSession);
    $('#btn-tts').addEventListener('click', genTTS);
    $('#btn-tts-batch').addEventListener('click', genBatchTTS);
  </script>
</body>
</html>
